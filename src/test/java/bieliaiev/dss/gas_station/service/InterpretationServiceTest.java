package bieliaiev.dss.gas_station.service;

import bieliaiev.dss.gas_station.model.interpretation.GsCategory;
import bieliaiev.dss.gas_station.model.interpretation.Interpretation;
import bieliaiev.dss.gas_station.model.interpretation.MemberFunction;
import bieliaiev.dss.gas_station.repository.interpretation.MemberFunctionRepository;
import org.assertj.core.data.Offset;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureWebMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.boot.test.mock.mockito.MockBean;

import java.util.List;
import java.util.Map;

import static org.assertj.core.api.Assertions.assertThat;
import static org.mockito.Mockito.when;

@AutoConfigureWebMvc
@SpringBootTest
class InterpretationServiceTest {

    @Autowired
    private InterpretationService service;

    @MockBean
    private MemberFunctionRepository functionRepository;

    @BeforeEach
    void setUp() {
        when(functionRepository.findAll()).thenReturn(List.of(
                new MemberFunction(0.0, 0.0, 0.3, 0.4, "«низька вразливість» означає, що у разі ймовірного виникнення аварійного інциденту на оціненій АЗС масштаби небажаних наслідків (економічних, соціальних та екологічних) можуть бути невисокими і задовольняють певному допустимому рівню.", "«низька вразливість»"),
                new MemberFunction(0.3, 0.4, 0.6, 0.7, "«середня вразливість» означає, що у разі ймовірного виникнення аварійного інциденту на оціненій АЗС масштаби небажаних наслідків (економічних, соціальних та екологічних) можуть бути більшими за середній рівень і можуть слугувати підставою для проведення експертизи оціненої АЗС на предмет дотримання всіх необхідних регламентів контролюючими органами і вжиття необхідних заходів.", "«середня вразливість»"),
                new MemberFunction(0.6, 0.7, 1.0, 1.0, "«висока вразливість» означає, що у разі ймовірного виникнення аварійного інциденту на оціненій АЗС масштаби небажаних наслідків (економічних, соціальних та екологічних) можуть бути великими, тобто такими, що можуть спричинити значний вплив і у цьому випадку перевірка оціненої АЗС на предмет дотримання всіх необхідних регламентів контролюючими органами рекомендована для вжиття заходів щодо зменшення загроз чи закриття ПНО.", "«висока вразливість»")
        ));
    }

    @Test
    void getInterpretation() {
        Interpretation result = service.getInterpretation(0.5);

        List<GsCategory> categories = result.getCategories();

        assertThat(result.getScore()).isCloseTo(0.5, Offset.offset(10e-6));
        assertThat(categories.get(0).getScore()).isCloseTo(0, Offset.offset(10e-6));
        assertThat(categories.get(1).getScore()).isCloseTo(1, Offset.offset(10e-6));
        assertThat(categories.get(2).getScore()).isCloseTo(0, Offset.offset(10e-6));
    }

    @Test
    void findVulnerabilityScore() {
        Map<String, Double> data = Map.of("E1", 0.5, "S1", 1.0, "A1", 0.0);
        List<Map<String, Double>> weights = List.of(
                Map.of("E1", 1.0, "S1", 0.0, "A1", 0.0),
                Map.of("E1", 0.0, "S1", 0.5, "A1", 0.5)
        );

        double result = service.findVulnerabilityScore(data, weights);

        assertThat(result).isCloseTo(0.5, Offset.offset(10e-6));
    }
}